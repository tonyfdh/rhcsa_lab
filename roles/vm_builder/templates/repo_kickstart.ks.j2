%post
# --- Network Persistence Fix (CRITICAL) ---
# Dynamically detect the primary network interface (not lo)
NIC=$(nmcli -t -f DEVICE,TYPE device | grep ethernet | head -1 | cut -d: -f1)

# If nmcli didn't work, fall back to ip command
if [ -z "$NIC" ]; then
    NIC=$(ip link show | grep -E '^[0-9]+: ' | grep -v lo | head -1 | awk -F': ' '{print $2}')
fi

# Check RHEL/Rocky version
if grep -q "release 9" /etc/redhat-release; then
    # RHEL 9 - use NetworkManager keyfile
    cat << EOF > /etc/NetworkManager/system-connections/$NIC.nmconnection
[connection]
id=$NIC
type=ethernet
interface-name=$NIC
autoconnect=true

[ethernet]

[ipv4]
address1={{ vm_ip }}/24,192.168.1.1
dns=8.8.8.8;
method=manual

[ipv6]
method=disabled
EOF
    chmod 600 /etc/NetworkManager/system-connections/$NIC.nmconnection
    
    # Remove any auto-generated connection that might conflict
    rm -f /etc/NetworkManager/system-connections/Wired*.nmconnection
else
    # RHEL 8 - use ifcfg file
    cat << EOF > /etc/sysconfig/network-scripts/ifcfg-$NIC
TYPE=Ethernet
BOOTPROTO=none
NAME=$NIC
DEVICE=$NIC
ONBOOT=yes
IPADDR={{ vm_ip }}
NETMASK=255.255.255.0
GATEWAY=192.168.1.1
DNS1=8.8.8.8
EOF
fi

# Ensure sys_admin has wheel/sudo access (or ansibleuser for repo)
echo "sys_admin ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers.d/sys_admin
chmod 0440 /etc/sudoers.d/sys_admin
%end