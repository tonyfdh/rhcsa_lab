lang en_US.UTF-8
keyboard us
timezone Etc/UTC
text
url --url="{{ vm_location_url }}"

# Static IP configuration for the repo VM
network --bootproto=static --ip={{ vm_ip }} --netmask=255.255.255.0 --gateway=192.168.1.1 --device=link --nameserver=8.8.8.8 --hostname={{ vm_name }} --activate

rootpw --plaintext examrepo
auth --enableshadow --passalgo=sha512
selinux --enforcing
firewall --enabled --ssh

# User for Ansible management
user --name=ansibleuser --password=ansiblepass --plaintext --groups=wheel

bootloader --location=mbr
clearpart --all --initlabel
part / --fstype="xfs" --size=20480
part swap --size=2048

%packages
@^minimal-environment
httpd
createrepo
rsync
net-tools
vim
%end

%post
# Determine the primary network interface
NIC=$(ip link show | grep -E '^[0-9]+: ' | grep -v lo | head -1 | cut -d: -f2 | tr -d ' ')

# Check RHEL/Rocky version
if grep -q "release 9" /etc/redhat-release; then
    # RHEL 9 - use NetworkManager keyfile
    cat << EOF > /etc/NetworkManager/system-connections/$NIC.nmconnection
[connection]
id=$NIC
type=ethernet
interface-name=$NIC

[ethernet]

[ipv4]
address1={{ vm_ip }}/24,192.168.1.1
dns=8.8.8.8;
method=manual

[ipv6]
method=disabled
EOF
    chmod 600 /etc/NetworkManager/system-connections/$NIC.nmconnection
else
    # RHEL 8 - use ifcfg file
    cat << EOF > /etc/sysconfig/network-scripts/ifcfg-$NIC
TYPE=Ethernet
BOOTPROTO=none
NAME=$NIC
DEVICE=$NIC
ONBOOT=yes
IPADDR={{ vm_ip }}
NETMASK=255.255.255.0
GATEWAY=192.168.1.1
DNS1=8.8.8.8
EOF
fi

echo "sys_admin ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers.d/sys_admin
chmod 0440 /etc/sudoers.d/sys_admin
# Enable and start sshd
systemctl enable sshd
systemctl enable httpd

%end

# THIS IS CRITICAL - tells kickstart to reboot after installation
reboot --eject