---
- name: üìÑ Copy Kickstart file for {{ vm_name }}
  ansible.builtin.template:
    src: "{{ vm_kickstart_template_name }}"
    dest: "/vmfs/rhcsa_storage/{{ vm_name }}_kickstart.ks"
    mode: '0644'
  
- name: üíª Define and start {{ vm_name }} VM installation
  ansible.builtin.shell: |
    # Construct the disk path arguments based on the vm_disks variable
    DISK_ARGS=""
    {% for disk in vm_disks %}
    DISK_ARGS="${DISK_ARGS} --disk path=/vmfs/rhcsa_storage/{{ vm_name }}_{{ loop.index }}.qcow2,size={{ disk.size }},pool=rhcsa_storage"
    {% endfor %}
    
    # Use inst.ip to enforce static IP during installation, which resolves DHCP fallback.
    # Format: ip=<ip>::<gateway>:<netmask>::<interface>:none
    VARS_EXTRA_ARGS="inst.ip={{ vm_ip }}::192.168.1.1:255.255.255.0:{{ vm_name }}:link:none"

    virt-install \
      --name {{ vm_name }} \
      --ram 8192 \
      --vcpus 2 \
      ${DISK_ARGS} \
      --os-variant {{ vm_os_variant }} \
      --location {{ vm_location_url }} \
      --initrd-inject "/vmfs/rhcsa_storage/{{ vm_name }}_kickstart.ks" \
      --extra-args "ks=file:/{{ vm_name }}_kickstart.ks console=tty0 console=ttyS0,115200n8 ${VARS_EXTRA_ARGS}" \
      --network bridge=NetBridge,model=virtio \
      --noautoconsole --wait 0
  args:
    creates: "/vmfs/rhcsa_storage/{{ vm_name }}_1.qcow2"
  register: vm_install_result
  
- name: ‚è≥ Wait for {{ vm_name }} SSH access before proceeding
  ansible.builtin.wait_for:
    port: 22
    host: "{{ vm_ip }}"
    timeout: 600
    delay: 15
  delegate_to: localhost
  when: vm_install_result.changed