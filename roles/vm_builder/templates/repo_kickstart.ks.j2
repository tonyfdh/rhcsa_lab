# CentOS Stream 9 - Golden Image Template Kickstart
lang en_US.UTF-8
keyboard us
timezone Etc/UTC
text

# Use the network mirror
url --url="{{ vm_location_url }}"

# MANDATORY: Tells Anaconda to reboot automatically when done
reboot --eject

# For a Golden Image, use DHCP. Ansible will set static IPs on the clones.
network --bootproto=dhcp --device=link --activate --hostname=base-template

rootpw --plaintext pa$$word
auth --enableshadow --passalgo=sha512
selinux --enforcing
firewall --enabled --ssh

# Main admin user
user --name=sys_admin --password=pa$$word --plaintext --groups=wheel

# Disk configuration
bootloader --location=mbr
clearpart --all --initlabel
part / --fstype="xfs" --size=15360  # 15GB Root
part swap --size=2048

%packages
@^minimal-environment
vim
net-tools
rsync
qemu-guest-agent
%end

%post --log=/root/ks-post.log
# 1. Setup Sudoers
echo "sys_admin ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers.d/sys_admin
chmod 0440 /etc/sudoers.d/sys_admin

# 2. Prepare SSH Directory
mkdir -p /home/sys_admin/.ssh
chmod 700 /home/sys_admin/.ssh

# 3. Optional: Inject your Public Key here if you have it handy
# echo "ssh-rsa YOUR_PUB_KEY_HERE" > /home/sys_admin/.ssh/authorized_keys
# chmod 600 /home/sys_admin/.ssh/authorized_keys

# 4. Fix permissions
chown -R sys_admin:sys_admin /home/sys_admin/.ssh

# 5. Enable services
systemctl enable sshd
systemctl enable qemu-guest-agent

# NOTE: Do NOT put a reboot command here. 
# The 'reboot --eject' at the top handles this gracefully.
%end