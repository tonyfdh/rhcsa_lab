---
# Shared Setup Tasks (Both VM1 and VM2)
- name: Create standard, non-privileged user henry
  ansible.builtin.user:
    name: henry
    password: "$6$test_salt$u/v3Y6j0O1P2q4r5s6t7W8x9Z0a1B2c3D4E5F6G7H8I9J0K1L2M3N4O5P6Q7R8S9T0" # Hash for 'testpass'
    state: present
    groups: [] # No sudo/wheel access
    
- name: Setup groups db_users and production
  ansible.builtin.group:
    name: "{{ item }}"
    state: present
  loop:
    - db_users
    - production
    
# Remove the initial Ansible control user (sys_admin takes over)
- name: Remove initial Ansible admin user (ansibleuser)
  ansible.builtin.user:
    name: ansibleuser
    state: absent
    remove: yes

- name: Ensure chronyd service is running and enabled
  ansible.builtin.systemd:
    name: chronyd
    state: started
    enabled: yes

- name: Configure firewalld to allow SSH permanently
  ansible.posix.firewalld:
    service: ssh
    permanent: yes
    state: enabled
    immediate: yes
  
# ----------------------------------------------------------------------
# VM1 SPECIFIC SETUP 
# ----------------------------------------------------------------------

- name: VM1 Set default boot target to multi-user.target
  ansible.builtin.command: systemctl set-default multi-user.target
  when: inventory_hostname == 'vm1'

- name: VM1 Initialize extra disks vdb and vdc for LVM objectives
  community.general.parted:
    device: "{{ item }}"
    label: gpt
  loop:
    - /dev/vdb
    - /dev/vdc
  when: inventory_hostname == 'vm1'

- name: VM1 Setup NFS export directory /opt/nfs
  ansible.builtin.file:
    path: /opt/nfs
    state: directory
    mode: '0775'
    owner: root
    group: production
  when: inventory_hostname == 'vm1'

- name: VM1 Create sample production data for NFS export
  ansible.builtin.copy:
    dest: /opt/nfs/prod_data.txt
    content: "This data is accessible from VM2 via NFS."
    owner: root
    group: production
  when: inventory_hostname == 'vm1'

- name: VM1 Setup NFS export for VM2 IP
  ansible.builtin.lineinfile:
    path: /etc/exports
    line: "/opt/nfs {{ hostvars['vm2']['ansible_host'] }}(rw,sync,no_root_squash)"
    state: present
    create: yes
  when: inventory_hostname == 'vm1'
  notify: Restart nfs-server

- name: VM1 Create target directory for database LVM objective at /opt/database
  ansible.builtin.file:
    path: /opt/database
    state: directory
    mode: '2770'
    owner: root
    group: db_users
  when: inventory_hostname == 'vm1'

- name: VM1 Create test data directory for grep/scripting objectives
  ansible.builtin.file:
    path: /data/backup_source
    state: directory
    mode: '0755'
  when: inventory_hostname == 'vm1'

- name: VM1 Create test log file with different lines for grep/redirection objectives
  ansible.builtin.copy:
    dest: /tmp/log_data.txt
    content: |
      INFO: Starting system services...
      ERROR: Network connection FAILED
      2025/11/29: Initializing disk 1
      WARNING: Service A started successfully
      ERROR: Disk read error FAILED
      2025/11/29: Boot sequence initiated
      WARNING: Backup process FAILED
      INFO: Finalizing installation...
    when: inventory_hostname == 'vm1'

# ----------------------------------------------------------------------
# VM2 SPECIFIC BREAKAGE SCENARIO SETUP
# ----------------------------------------------------------------------

- name: VM2 Set INCORRECT and non-functional IP and Hostname
  when: inventory_hostname == 'vm2'
  block:
    - name: VM2 Set incorrect temporary hostname (broken-server)
      ansible.builtin.hostname:
        name: broken-server.example.net

    - name: VM2 Configure incorrect static IP (192.168.1.199)
      ansible.builtin.lineinfile:
        path: /etc/sysconfig/network-scripts/ifcfg-eth0
        regexp: '^IPADDR='
        line: 'IPADDR=192.168.1.199' 
        state: present
      notify: Restart NetworkManager

    - name: VM2 Set INCORRECT primary nameserver (192.168.1.99)
      ansible.builtin.lineinfile:
        path: /etc/sysconfig/network-scripts/ifcfg-eth0
        regexp: '^DNS1='
        line: 'DNS1=192.168.1.99'
        state: present
      notify: Restart NetworkManager

- name: VM2 Configure HTTPD on custom port 82
  when: inventory_hostname == 'vm2'
  block:
    - name: VM2 Modify httpd Listen port to 82
      ansible.builtin.lineinfile:
        path: /etc/httpd/conf/httpd.conf
        regexp: '^Listen 80'
        line: 'Listen 82'
        state: present
      notify: Restart httpd

    - name: VM2 Create basic index file with incorrect permissions
      ansible.builtin.copy:
        content: |
          <!DOCTYPE html><html><body><h1>Service Is Down. Fix Me!</h1></body></html>
        dest: /var/www/html/index.html
        owner: root
        group: root
        mode: '0600'

    - name: VM2 Create "Great Success!" file
      ansible.builtin.copy:
        content: |
          <!DOCTYPE html><html><body><h1>Great Success!</h1></h1></body></html>
        dest: /var/www/html/success.html
        owner: apache
        group: apache
        mode: '0644'

    - name: VM2 Open port 82 in firewalld
      ansible.posix.firewalld:
        port: 82/tcp
        permanent: yes
        state: enabled
        immediate: yes
      
    - name: VM2 Set initial incorrect SELinux file context (ssh_home_t)
      community.general.sefcontext:  # <--- CORRECTED FQCN
        target: '/var/www/html(/.*)?'
        setype: ssh_home_t
        state: present
      notify: Restart httpd

- name: VM2 Start hidden, CPU intensive process for troubleshooting objective
  ansible.builtin.shell: |
    nohup /bin/bash -c 'while true; do echo "scale=5000; a(1)*4" | bc -l > /dev/null; done' &
  args:
    chdir: /tmp
    executable: /bin/bash
  when: inventory_hostname == 'vm2'

# ----------------------------------------------------------------------
# VM2 BREAKAGE TASKS (MUST BE LAST IN THIS BLOCK)
# ----------------------------------------------------------------------
- name: VM2 BREAK Inject bad entry into fstab to prevent boot
  ansible.builtin.lineinfile:
    path: /etc/fstab
    line: '/dev/vg_broken/lv_broken /mnt/badmount xfs defaults 0 0'
    insertafter: EOF
    state: present
  when: inventory_hostname == 'vm2'

- name: VM2 BREAK Change root password to unknown hash
  ansible.builtin.user:
    name: root
    password: "$6$random_salt$Z0bC7E5f2J4v9Y3x8w1N6p0q5R8a3T7u2d4G6m9L5"
    update_password: on_create
  when: inventory_hostname == 'vm2'

- name: VM2 BREAK Lock the sys_admin account
  ansible.builtin.user:
    name: sys_admin
    locked: yes
  when: inventory_hostname == 'vm2'
  
- name: VM2 Final warning message before rebooting
  ansible.builtin.debug:
    msg: "VM2 has been broken and must be fixed using the emergency mode procedure."
  when: inventory_hostname == 'vm2'