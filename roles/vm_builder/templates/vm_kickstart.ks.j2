# CentOS Stream 9 - Golden Image Template Kickstart
# This template is designed to be built ONCE, then cloned.
lang en_US.UTF-8
keyboard us
timezone Etc/UTC
text

# Installation source - This should point to your Repo VM or a public mirror
url --url="{{ vm_location_url }}"

# COMMAND SECTION: Forces automatic reboot and ejects "media"
reboot --eject

# For a Golden Image, we use DHCP. Static IPs are applied to CLONES via Ansible.
network --bootproto=dhcp --device=link --activate --hostname=base-template

# Password Management
# Hash for 'pa$$word': $6$rhcsa_salt$86yN3D4i9B9e0.bS2x/7c1tM1w8Y5s7V3f6P5F6I2
rootpw --iscrypted $6$rhcsa_salt$86yN3D4i9B9e0.bS2x/7c1tM1w8Y5s7V3f6P5F6I2
auth --enableshadow --passalgo=sha512
selinux --enforcing
firewall --enabled --ssh

# Standard admin user
user --name=sys_admin --iscrypted $6$rhcsa_salt$86yN3D4i9B9e0.bS2x/7c1tM1w8Y5s7V3f6P5F6I2 --groups=wheel

# Disk Partitioning
bootloader --location=mbr
clearpart --all --initlabel
part / --fstype="xfs" --size=10240 
part /boot --fstype="xfs" --size=1024
part swap --size=2048

%packages
@^minimal-environment
@guest-agents
vim
net-tools
rsync
tar
%end

%post --log=/root/ks-post.log
# 1. Setup Sudoers for Ansible
echo "sys_admin ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers.d/sys_admin
chmod 0440 /etc/sudoers.d/sys_admin

# 2. Prep SSH for Ansible Key Injection later
mkdir -p /home/sys_admin/.ssh
chmod 700 /home/sys_admin/.ssh
chown sys_admin:sys_admin /home/sys_admin/.ssh

# 3. Enable guest agent so the Host can see the VM status
systemctl enable qemu-guest-agent
%end