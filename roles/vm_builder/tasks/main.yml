---
- name: ðŸ“„ Copy Kickstart file for {{ vm_name }}
  ansible.builtin.template:
    src: "{{ vm_kickstart_template_name }}"
    dest: "/vmfs/rhcsa_storage/{{ vm_name }}_kickstart.ks"
    mode: '0644'
  
- name: ðŸ’» Define and start {{ vm_name }} VM installation
  ansible.builtin.shell: |
    # Construct the disk path arguments based on the vm_disks variable
    DISK_ARGS=""
    {% for disk in vm_disks %}
    DISK_ARGS="${DISK_ARGS} --disk path=/vmfs/rhcsa_storage/{{ vm_name }}_{{ loop.index }}.qcow2,size={{ disk.size }},pool=rhcsa_storage"
    {% endfor %}
    
    # Run the virt-install command
    virt-install \
      --name {{ vm_name }} \
      --ram {{ vm_ram }} \
      --vcpus 2 \
      ${DISK_ARGS} \
      --os-variant {{ vm_os_variant }} \
      --location {{ vm_location_url }} \
      --initrd-inject "/vmfs/rhcsa_storage/{{ vm_name }}_kickstart.ks" \
      --extra-args "inst.ks=file:/{{ vm_name }}_kickstart.ks console=tty0 console=ttyS0,115200n8 inst.ip={{ vm_ip }}::192.168.1.1:255.255.255.0::eth0:none" \
      --network bridge=NetBridge,model=virtio \
      --noautoconsole --wait 0
  args:
    # Check if the primary disk exists to determine if installation is needed
    creates: "/vmfs/rhcsa_storage/{{ vm_name }}_1.qcow2"
  register: vm_install_result
  
- name: Wait for {{ vm_name }} SSH access before proceeding
  ansible.builtin.wait_for:
    port: 22
    host: "{{ vm_ip }}"
    timeout: 600
    delay: 15
  delegate_to: localhost
  when: vm_install_result.changed

- name: Check if SSH key exists for current user
  ansible.builtin.stat:
    path: "{{ ansible_env.HOME }}/.ssh/id_rsa.pub"
  register: ssh_key_stat
  delegate_to: localhost

- name: Generate SSH key pair if it doesn't exist
  ansible.builtin.command:
    cmd: "ssh-keygen -t rsa -b 4096 -f {{ ansible_env.HOME }}/.ssh/id_rsa -N ''"
    creates: "{{ ansible_env.HOME }}/.ssh/id_rsa"
  delegate_to: localhost
  when: not ssh_key_stat.stat.exists

- name: Read SSH public key
  ansible.builtin.slurp:
    src: "{{ ansible_env.HOME }}/.ssh/id_rsa.pub"
  register: ssh_public_key
  delegate_to: localhost

- name: Ensure .ssh directory exists for sys_admin
  ansible.builtin.file:
    path: /home/sys_admin/.ssh
    state: directory
    owner: sys_admin
    group: sys_admin
    mode: '0700'
  delegate_to: "{{ vm_ip }}"
  vars:
    ansible_user: sys_admin
    ansible_password: pa$$word

- name: Install SSH key for sys_admin user on {{ vm_name }}
  ansible.builtin.lineinfile:
    path: /home/sys_admin/.ssh/authorized_keys
    line: "{{ ssh_public_key['content'] | b64decode | trim }}"
    create: yes
    mode: '0600'
    owner: sys_admin
    group: sys_admin
  delegate_to: "{{ vm_ip }}"
  vars:
    ansible_user: sys_admin
    ansible_password: pa$$word