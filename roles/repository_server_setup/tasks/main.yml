# --- CENTOS REPO CONFIGURATION (Fixes "No package available") ---
- name: Disable Subscription Manager Plugin
  ansible.builtin.lineinfile:
    path: /etc/yum/pluginconf.d/subscription-manager.conf
    regexp: '^enabled='
    line: 'enabled=0'
    state: present

- name: Import CentOS Stream 9 GPG Key
  rpm_key:
    state: present
    key: https://www.centos.org/keys/RPM-GPG-KEY-CentOS-Official

- name: Add CentOS Stream 9 BaseOS Repo
  ansible.builtin.yum_repository:
    name: centos-stream-baseos
    description: CentOS Stream 9 BaseOS
    baseurl: https://mirror.stream.centos.org/9-stream/BaseOS/$basearch/os/
    gpgcheck: yes
    gpgkey: https://www.centos.org/keys/RPM-GPG-KEY-CentOS-Official
    enabled: yes

- name: Add CentOS Stream 9 AppStream Repo
  ansible.builtin.yum_repository:
    name: centos-stream-appstream
    description: CentOS Stream 9 AppStream
    baseurl: https://mirror.stream.centos.org/9-stream/AppStream/$basearch/os/
    gpgcheck: yes
    gpgkey: https://www.centos.org/keys/RPM-GPG-KEY-CentOS-Official
    enabled: yes

# --- PACKAGE INSTALLATION ---
- name: Install Repo Tools
  ansible.builtin.dnf:
    name:
      - httpd
      - createrepo_c             # <-- UPDATED NAME for EL9
      - flatpak
      - policycoreutils-python-utils
    state: present
    disablerepo: "*"
    enablerepo: "centos-stream*" # Force usage of our new repos

# --- STORAGE SETUP (300GB Disk) ---
- name: Create Partition on Data Disk
  community.general.parted:
    device: /dev/vdb
    number: 1
    state: present
    fs_type: xfs

- name: Format Data Disk
  ansible.builtin.filesystem:
    fstype: xfs
    dev: /dev/vdb1

- name: Create Web Root for Repos
  ansible.builtin.file:
    path: /var/www/html/repos
    state: directory
    mode: '0755'
    # We set this, but mounting might hide it, so we fix it after mount too
    setype: httpd_sys_content_t

- name: Mount Data Disk
  ansible.builtin.mount:
    path: /var/www/html/repos
    src: /dev/vdb1
    fstype: xfs
    state: mounted

# CRITICAL FIX: Restore SELinux context AFTER mount
- name: Restore SELinux Context on Repo Dir
  ansible.builtin.command: restorecon -Rv /var/www/html/repos

# --- FLATPAK SETUP ---
- name: Create Flatpak Repo Directory
  ansible.builtin.file:
    path: /var/www/html/flatpak_repo
    state: directory
    mode: '0755'
    setype: httpd_sys_content_t

- name: Initialize Flatpak Repository
  ansible.builtin.command:
    cmd: flatpak build-export-repo /var/www/html/flatpak_repo
  args:
    creates: /var/www/html/flatpak_repo/config

# --- HTTPD & FIREWALL ---
- name: Enable and Start HTTPD
  ansible.builtin.service:
    name: httpd
    state: started
    enabled: yes

- name: Open Firewall for HTTP
  ansible.posix.firewalld:
    service: http
    permanent: yes
    state: enabled
    immediate: yes

# --- HELPER SCRIPTS ---
- name: Create Sync Script
  ansible.builtin.copy:
    dest: /usr/local/bin/sync_repos.sh
    mode: '0755'
    content: |
      #!/bin/bash
      # Syncing from CentOS Stream 9 mirrors
      echo "Syncing BaseOS..."
      reposync -p /var/www/html/repos --repo=centos-stream-baseos --download-metadata
      
      echo "Syncing AppStream..."
      reposync -p /var/www/html/repos --repo=centos-stream-appstream --download-metadata
      
      # Using createrepo_c
      createrepo_c /var/www/html/repos/centos-stream-baseos
      createrepo_c /var/www/html/repos/centos-stream-appstream
      echo "Done."

- name: Create Client .repo File (Hosted on Server)
  ansible.builtin.copy:
    dest: /var/www/html/lab.repo
    mode: '0644'
    content: |
      [lab-baseos]
      name=Lab BaseOS
      baseurl=http://192.168.55.10/repos/centos-stream-baseos
      gpgcheck=0
      enabled=1

      [lab-appstream]
      name=Lab AppStream
      baseurl=http://192.168.55.10/repos/centos-stream-appstream
      gpgcheck=0
      enabled=1